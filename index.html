<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8">
<title>åŒè¯­å‘éŸ³å­¦ä¹ å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family:"Segoe UI","Noto Sans","Noto Sans JP",sans-serif; padding:20px; background:#f7fbff; color:#111; }
  h2 { margin-top:0; }
  textarea { width:100%; height:180px; padding:8px; box-sizing:border-box; font-family:monospace; resize:vertical; }
  button { padding:10px 16px; border-radius:6px; border:none; cursor:pointer; font-size:14px; }
  button.main { background:#0366d6; color:#fff; }
  button.main:hover { background:#024ea1; }
  button.clear { background:#f3f4f6; color:#333; border:1px solid #ddd; }
  button.clear:hover { background:#e5e7eb; }
  button.paste { background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
  button.paste:hover { background:#fcd34d; }
  #output { margin-top:16px; white-space:pre-wrap; font-family:inherit; background:#fff; padding:12px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.06); max-height:60vh; overflow:auto; }
  .word { background:#e6f0ff; border-radius:6px; padding:2px 6px; margin:0 4px 4px 0; display:inline-flex; align-items:center; gap:6px; cursor:pointer; word-break:break-word; }
  .word:hover { background:#cfe6ff; }
  .flag { font-size:14px; user-select:none; }
  .toggle { font-size:12px; border:none; background:transparent; cursor:pointer; padding:2px 4px; border-radius:4px; }
  .controls { margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .note { color:#555; font-size:13px; }
  .tiny { font-size:12px; color:#666; margin-left:6px; }
</style>
</head>
<body>

<h2>åŒè¯­å‘éŸ³å­¦ä¹ å¡ï¼ˆGoogle TTS + å›½æ—— + ç²˜è´´æŒ‰é’®ï¼‰</h2>
<p class="note">
  ç²˜è´´æˆ–è¾“å…¥ä½ çš„ % @ || æ–‡æœ¬ â†’ ç‚¹å‡»â€œç”Ÿæˆå‘éŸ³åŒºå—â€ã€‚<br>
  å•è¯ç‚¹å‡»æ’­æ”¾ï¼ˆGoogle TTS ğŸ‡¯ğŸ‡µğŸ‡»ğŸ‡³ï¼‰ï¼Œç‚¹å‡» â‡„ åˆ‡æ¢è¯­è¨€å¹¶ç«‹å³æ’­æ”¾ã€‚
</p>

<textarea id="input" placeholder="ç²˜è´´ä½ çš„å¸¦ % å’Œ @ çš„åŸæ–‡â€¦â€¦ï¼ˆä¿æŒåŸæ ·ï¼‰"></textarea>
<div class="controls">
  <button class="main" onclick="generate()">ç”Ÿæˆå‘éŸ³åŒºå—</button>
  <button class="paste" onclick="pasteFromClipboard()">ğŸ“‹ ç²˜è´´å†…å®¹</button>
  <button class="clear" onclick="clearInput()">ğŸ§¹ æ¸…ç©ºè¾“å…¥</button>
  <span class="tiny">æç¤ºï¼šå•è¯ç‚¹å‡»å‘éŸ³ï¼Œâ‡„ åˆ‡æ¢è¯­è¨€</span>
</div>

<div id="output" role="region" aria-live="polite"></div>

<script>
async function playGoogleTTS(text, lang){
  if(!text || text.trim()==='') return;
  try {
    const url = `/tts?text=${encodeURIComponent(text)}&lang=${encodeURIComponent(lang)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
    const blob = await res.blob();
    const audio = new Audio(URL.createObjectURL(blob));
    await audio.play();
  } catch(err){
    console.warn('æ’­æ”¾å¤±è´¥', err);
  }
}

function clearInput() {
  document.getElementById('input').value='';
  document.getElementById('input').focus();
  document.getElementById('output').innerHTML='';
}

async function pasteFromClipboard() {
  try{
    const text=await navigator.clipboard.readText();
    clearInput();
    document.getElementById('input').value=text;
    document.getElementById('input').focus();
  } catch(err){
    alert('è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·ç¡®ä¿æµè§ˆå™¨å…è®¸è®¿é—®å‰ªè´´æ¿ã€‚');
    console.error(err);
  }
}

function detectLangSmart(text){
  if(!text) return 'vi';
  if(/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(text)) return 'ja';
  const vietDiacritics=/[ÄƒÃ¢Ä‘ÃªÃ´Æ¡Æ°Ã¡Ã áº£Ã£áº¡áº¥áº§áº©áº«áº­áº¯áº±áº³áºµáº·Ã©Ã¨áº»áº½áº¹áº¿á»á»ƒá»…á»‡Ã­Ã¬á»‰Ä©á»‹Ã³Ã²á»Ãµá»á»‘á»“á»•á»—á»™á»›á»á»Ÿá»¡á»£ÃºÃ¹á»§Å©á»¥á»©á»«á»­á»¯á»±Ã½á»³á»·á»¹á»µ]/i;
  if(vietDiacritics.test(text)) return 'vi';
  const lower=text.toLowerCase();
  const vietnameseSeeds=['thit','nay','nÃ y','hoi','hÆ¡i','man','máº·n','toi','tÃ´i','ban','báº¡n','cai','cÃ¡i','la','lÃ ','va','vÃ ','khong','khÃ´ng','co','cÃ³','nha','nhÃ ','an','Äƒn','uong','uá»‘ng','the','tháº¿','mot','má»™t'];
  for(const w of vietnameseSeeds) if(lower.includes(w)) return 'vi';
  const parts=lower.split(/\s+/).filter(Boolean);
  if(parts.length>1){ let viCount=0; for(const p of parts) for(const s of vietnameseSeeds) if(p.includes(s)){viCount++;break;} if(viCount>=Math.max(1,Math.floor(parts.length/2))) return 'vi'; }
  return 'vi';
}

function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function generate(){
  const raw=document.getElementById('input').value;
  if(!raw){document.getElementById('output').textContent='è¯·å…ˆè¾“å…¥å†…å®¹ã€‚'; return;}
  let html=escapeHtml(raw);
  html=html.replace(/%([^%@\n]+?)@/g,(m,inner)=>{
    const word=inner.trim();
    const lang=detectLangSmart(word);
    return '%'+makeWordHtml(word,lang)+'@';
  });
  html=html.replace(/^([^%@\n]+?)@/gm,(m,part)=>{
    const word=part.trim();
    const lang=detectLangSmart(word);
    return makeWordHtml(word,lang)+'@';
  });
  document.getElementById('output').innerHTML=html;
  attachListeners();
}

function makeWordHtml(word,lang){
  const flag=(lang==='ja')?'ğŸ‡¯ğŸ‡µ':'ğŸ‡»ğŸ‡³';
  const safeWord=escapeHtml(word);
  return `<span class="word" data-original="${safeWord}" data-lang="${lang}">
            <button class="toggle" title="åˆ‡æ¢è¯­è¨€ (æ—¥/è¶Š)" onclick="toggleLang(event,this)">â‡„</button>
            <span class="flag">${flag}</span>
            <span class="text">${safeWord}</span>
          </span>`;
}

function attachListeners(){
  document.querySelectorAll('#output .word').forEach(span=>{
    span.removeEventListener('click',onWordClick);
    span.addEventListener('click',onWordClick);
    updateFlag(span);
  });
}

function onWordClick(e){
  if(e.target.closest('.toggle')) return;
  const span=e.currentTarget;
  const text=span.getAttribute('data-original')||span.textContent;
  const lang=span.getAttribute('data-lang')||'vi';
  playGoogleTTS(text,lang);
}

function toggleLang(e,btn){
  e.stopPropagation();
  const span=btn.closest('.word');
  if(!span) return;
  const cur=span.getAttribute('data-lang')||'vi';
  const next=(cur==='vi')?'ja':'vi';
  span.setAttribute('data-lang',next);
  updateFlag(span);
  const text=span.getAttribute('data-original')||span.textContent;
  playGoogleTTS(text,next);
}

function updateFlag(span){
  const lang=span.getAttribute('data-lang')||'vi';
  const flagEl=span.querySelector('.flag');
  flagEl.textContent=(lang==='ja')?'ğŸ‡¯ğŸ‡µ':'ğŸ‡»ğŸ‡³';
}

document.addEventListener('DOMContentLoaded',()=>{
  const example=`ã“ã®||è‚‰||ã¯||å°‘ã—||ã—ã‚‡ã£ã±ã„||ã§ã™ï¼@
Kono||niku||wa||sukoshi||shoppai||desu!
è¿™ä¸ªè‚‰æœ‰ç‚¹å’¸ï¼
%
Thá»‹t|nÃ y|hÆ¡i|máº·n!@
è¿™ä¸ªè‚‰æœ‰ç‚¹å’¸ï¼
%
ã“ã®@ï¼ˆkonoï¼‰ï¼ˆè¿ä½“è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šè¿™ä¸ªï¼‰%
è‚‰@ï¼ˆnikuï¼‰ï¼ˆåè¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šè‚‰ï¼‰%
ã¯@ï¼ˆwaï¼‰ï¼ˆåŠ©è¯ï¼‰ï¼ˆä¸»é¢˜æ ‡è®°ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šè¡¨ç¤ºä¸»é¢˜ï¼‰%
å°‘ã—@ï¼ˆsukoshiï¼‰ï¼ˆå‰¯è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šä¸€ç‚¹ï¼Œæœ‰ç‚¹ï¼‰%
ã—ã‚‡ã£ã±ã„@ï¼ˆshoppaiï¼‰ï¼ˆå½¢å®¹è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šå’¸çš„ï¼‰%
ã§ã™@ï¼ˆdesuï¼‰ï¼ˆåˆ¤æ–­åŠ©åŠ¨è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šæ˜¯ï¼Œç”¨äºç¤¼è²Œè¡¨è¾¾ï¼‰%
%
Thá»‹t@âœ…ï¼ˆåè¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šè‚‰ï¼‰%
nÃ y@âœ…ï¼ˆæŒ‡ç¤ºè¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šè¿™ä¸ªï¼‰%
hÆ¡i@âœ…ï¼ˆå‰¯è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šæœ‰ç‚¹ï¼Œç¨å¾®ï¼‰%
máº·n@âœ…ï¼ˆå½¢å®¹è¯ï¼‰ï¼ˆä¸­æ–‡é‡Šä¹‰ï¼šå’¸çš„ï¼‰%`;
  const area=document.getElementById('input');
  if(!area.value) area.value=example;
});
</script>

</body>
</html>
